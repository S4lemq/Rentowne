<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="001-create_function_p_add_check_constraint" author="plubowicz">
        <sql splitStatements="false">
            CREATE OR REPLACE FUNCTION p_add_check_constraint(
                tablename TEXT,
                columnname TEXT
            ) RETURNS VOID
                LANGUAGE plpgsql AS
            $BODY$
            DECLARE
                constraintnumber INTEGER := 1;
                added            BOOLEAN := FALSE;
                query            TEXT;
            BEGIN
                LOOP
                    EXIT WHEN added;
                    BEGIN
                        query := 'ALTER TABLE ' || tablename ||
                                 ' ALTER COLUMN ' || columnname ||
                                 ' SET NOT NULL';
                        EXECUTE query;
                        added := TRUE;
                    EXCEPTION
                        WHEN duplicate_object THEN
                            constraintnumber := constraintnumber + 1;
                    END;
                END LOOP;
            END;
            $BODY$;
        </sql>
    </changeSet>

</databaseChangeLog>